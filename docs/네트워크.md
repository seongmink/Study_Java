# 네트워크

## 네트워크 기초

네트워크(network)는 여러 대의 컴퓨터를 통신 회선으로 연결한 것을 말한다. 지역 네트워크는 회사, 건물, 특정 영역에 존재하는 컴퓨터를 통신 회선으로 연결한 것을 말하고, 인터넷(internet)은 지역 네트워크를 통신 회선으로 연결한 것을 말한다.

- ### 서버와 클라이언트

  서비스를 제공하는 프로그램을 일반적으로 서버(server)라고 부르고, 서비스를 받는 프로그램을 클라이언트(client)라고 부른다. 클라이언트는 서비스를 받기 위해 연결을 요청하고, 서버는 연결을 수락하여 서비스를 제공해준다. 서버는 클라이언트가 요청(request)하는 내용을 처리해주고, 응답(response)을 클라이언트로 보낸다.

  클라이언트/서버 모델은 한 개의 서버와 다수의 클라이언트로 구성되는 것이 보통이나 두 개의 프로그램이 서버인 동시에 클라이언트 역할을 하는 P2P(peer to peer) 모델도 있다. P2P 모델에서는 먼저 접속을 시도한 컴퓨터가 클라이언트가 된다.

- ### IP 주소와 포트(Port)

  IP 주소는 네트워크 어댑터(랜 카드)마다 할당되는데, 한 개의 컴퓨터에 두 개의 네트워크 어댑터가 장착되어 있다면, 두 개의 IP 주소를 할당할 수 있다. 네트워크 어댑터에 어떤 IP 주소가 부여되어 있는지 확인하려면 명령 프롬프트(cmd.exe)에서 다음과 같이 실행하면 된다.

  ```
  C:\>ipconfig /all
  ```

  IP는 컴퓨터의 네트워크 어댑터까지만 갈 수 있는 정보이기 때문에 컴퓨터 내에서 실행하는 서버를 선택하기 위해서는 추가적인 정보가 필요하다. 이 정보가 **포트**(port) 번호이다. 서버는 시작할 때 고정적인 포트 번호를 가지고 실행하는데, 이것을 포트 바인딩(binding)이라고 한다. 예를 들어 기본적으로 웹 서버는 80번과 바인딩하고, FTP 서버는 21번과 바인딩한다. 클라이언트가 웹 서버에 연결하려면 80번으로 연결 요청을 해야 하고, FTP 서버에 연결하려면 21번으로 연결 요청을 해야 한다.

  클라이언트도 서버에서 보낸 정보를 받기 위해 포트 번호가 필요한데, 서버와 같이 고정적인 포트번호가 아니라 운영체제가 자동으로 부여하는 동적 포트 번호를 사용한다. 이 동적 포트 번호는 클라이언트가 서버로 연결 요청을 할 때 전송되어 서버가 클라이언트로 데이터를 보낼 때 사용된다. 포트 번호의 전체 범위는 0~65535인데, 다음과 같이 세 가지 범위로 구분된다.

  | 구분명                          | 범위        | 설명                                                         |
  | ------------------------------- | ----------- | ------------------------------------------------------------ |
  | Well Know Port Numbers          | 0~1023      | 국제인터넷주소관리기구(ICANN)가 특정 애플리케이션용으로 미리 예약한 포트 |
  | Registered Port Numbers         | 1024~49151  | 회사에서 등록해서 사용할 수 있는 포트                        |
  | Dynamic Or Private Port Numbers | 49152~65535 | 운영체제가 부여하는 동적 포트 또는 개인적인 목적으로 사용할 수 있는 포트 |

- ### InetAddress로 IP 주소 얻기

  자바는 IP 주소를 java.net.InetAddress 객체로 표현한다. InetAddress는 로컬 컴퓨터의 IP 주소뿐만 아니라 도메인 이름을 DNS에서 검색한 후 IP 주소를 가져오는 기능을 제공한다. 로컬 컴퓨터의 InetADdress를 얻고 싶다면 InetAddress.getLocalHost() 메소드를 다음과 같이 호출하면 된다.

  ```java
  InetAddress ia = InetAddress.getLocalHost();
  ```

  외부 컴퓨터의 도메인 이름을 알고 있다면 다음 두 개의 메소드를 사용하여 InetAddress 객체를 얻으면 된다.

  ```java
  InetAddress ia = InetAddress.getByName(String host);
  InetAddress[] iaArr = InetAddress.getAllByName(String host);
  ```

  getByName() 메소드는 매개값으로 준 도메인 이름으로 DNS에서 단 하나의 IP 주소를 얻어와 InetAddress를 생성하고 리턴한다. 연결 클라이언트가 많은 회사의 경우 서버의 과부하를 막기 위해 하나의 도메인 이름에 여러 개의 컴퓨터 IP를 등록해서 운영하기도 한다. 이 경우 DNS에 등록된 모든 IP 주소를 얻고 싶다면 getAllByName() 메소드를 호출하면 된다. 리턴 타입은 InetAddress[] 배열이다. InetAddress 객체에서 IP주소를 얻기 위해서는 getHostAddress() 메소드를 다음과 같이 호출하면 된다. 리턴값은 문자열로된 IP 주소이다.

  ```java
  String ip = InetAddress.getHostAddress();
  ```

  ##### InetAddressExample 클래스

  ```java
  public class InetAddressExample {
      public static void main(String[] args) {
          try {
              InetAddress local = InetAddress.getLocalHost();
              System.out.println("내 컴퓨터 IP : " + local.getHostAddress());
              
              InetAddress[] iaArr = InetAddress.getAllByName("www.naver.com");
              for(InetAddresss remote : iaArr) {
                  System.out.println("www.naver.com IP 주소 : " + remote.getHostAddress());
              }
          } catch(UnknownHostException e) {
              System.out.println(e);
          }
      }
  }
  ```

## TCP 네트워킹

TCP(Transmission Control Protocol)는 연결 지향적 프로토콜이다. 연결 지향 프로토콜이란 클라이언트와 서버가 연결된 상태에서 데이터를 주고받는 프로토콜을 말한다. 클라이언트가 연결 요청을 하고, 서버가 연결을 수락하면 통신 선로가 고정되고, 모든 데이터는 고정된 통신 선로를 통해서 순차적으로 전달된다. 그렇기 때문에 TCP는 데이터를 정확하고 안정적으로 전달한다. TCP의 단점은 데이터를 보내기 전에 반드시 연결이 형성되어야 하고(가장 시간이 많이 걸리는 작업), 곶어된 통신 선로가 최단선(네트워크 길이 측면)이 아닐 경우 상대적으로 UDP(User Datagram Protocol)보다 데이터 전송 속도가 느릴 수 있다. 자바는 TCP 네트워킹을 위해 java.net.ServerSocekt과 java.net.Socekt 클래스를 제공하고 있다.

- ### ServerSocket과 Socket의 용도

  TCP 서버의 역할은 두 가지로 볼 수 있다. 하나는 클라이언트가 연결 요청을 해오면 연결을 수락하는 것이고, 다른 하나는 연결된 클라이언트와 통신하는 것이다. 자바에서는 이 두 역할별로 별도의 클래스르 제공하고 있다. 

  클라이언트의 연결 요청을 기다리면서 연결 수락을 담당하는 것이 java.net.ServerSocket 클래스이고, 연결된 클라이언트와 통신을 담당하는 것이 java.net.Socket 클래스이다. 클라이언트가 요청을 해오면 ServerSocket은 연결을 수락하고 통신용 Socket을 만든다.

  서버는 클라이언트가 접속할 포트를 가지고 있어야 하는데, 이 포트를 바인딩(binding) 포트라고 한다. 서버는 고정된 포트 번호에 바인딩해서 실행하므로, ServerSocket을 생성할 때 포트 번호 하나를 지정해야 한다. 서버가 실행되면 클라이언트는 서버의 IP 주소와 바인딩 포트 번호로 Socket을 생성해서 연결 요청을 할 수 있다. ServerSocket은 클라이언트가 연결 요청을 해오면 accpet() 메소드로 연결 수락을 하고 통신용 Socket을 생성한다. 그리고 나서 클라이언트와 서버는 각각의 Socket을 이용해서 데이터를 주고받게 된다.

- ### ServerSocket 생성과 연결 수락

  서버를 개발하려면 우선 ServerSocket 객체를 얻어야 한다. ServerSocket을 얻는 가장 간단한 방법은 생성자에 바인딩 포트를 대입하고 객체를 생성하는 것이다. 다음은 5001번 포트에 바인딩하는 ServerSocket을 생성한다.

  ```java
  ServerSocket serverSocket = new ServerSocket(5001);
  ```

  ServerSocket을 얻는 다른 방법은 디폴트 생성자로 객체를 생성하고 포트 바인딩을 위해 bind() 메소드를 호출하는 것이다. bind() 메소드의 매개값은 포트 정보를 가진 InetSocketAddress이다.

  ```java
  ServerSocket serverSocket = new ServerSocket();
  serverSocket.bind(new InetSocketAddress(5001));
  ```

   만약 서버 PC에 멀티 IP가 할당되어 있을 경우, 특정 IP로 접속할 때만 연결 수락을 하고 싶다면 다음과 같이 작성하되, "localhost" 대신 정확한 IP를 주면 된다.

  ```java
  ServerSocket serverSocket = new ServerSocket();
  serverSocket.bind(new InetSocketAddress("localhost", 5001));
  ```

  ServerSocket을 생성할 때 해당 포트가 이미 다른 프로그램에서 상요 중이라면 BindException이 발생한다. 이 경우에는 다른 포트로 바인딩하거나, 다른 프로그램을 종료하고 다시 실행하면 된다.

  포트 바인딩까지 끝났다면 ServerSocket은 클라이언트 연결 수락을 위해 accept() 메소드를 실행해야 한다. accept() 메소드는 클라이언트가 연결 요청하기 전까지 블로킹되는데, 블로킹이란 스레드가 대기 상태가 된다는 뜻이다. 그렇기 때문에 UI를 생성하는 스레드나, 이벤트를 처리하는 스레드에서 accept() 메소드를 호출하지 않도록 한다. 블로킹이 되면 UI 갱신이나 이벤트 처리를 할 수 없기 때문이다. 클라이언트가 연결 요청을 하면 accept()는 클라이언트와 통신할 Socket을 만들고 리턴한다. 이것이 연결 수락이다. 만약 accept()에서 블로킹되어 있을 때 ServerSocket을 닫기 위해 close() 메소드를 호출하면 SocketException이 발생한다. 그렇기 때문에 예외 처리가 필요하다.

  ```java
  try {
      Socket socket = serverSocket.accept();
  } catch(Exception e) { }
  ```

  연결된 클라이언트의 IP와 포트 정보를 알고 싶다면 Socket의 getRemoteSocketAddress() 메소드를 호출해서 SocketAddress를 얻으면 된다. 실제 리턴되는 것은 InetSocketAddress 객체 이므로 다음과 같이 타입 변환할 수 있다.

  ```java
  InetSocketAddress socketAddress = (InetSocketAddress) socket.getRemoteSocketAddress();
  ```

  InetSocketAddress에는 IP와 포트 정보를 리턴하는 다음과 같은 메소드들이 있다.

  | 리턴 타입 | 메소드명(매개 변수) | 설명                             |
  | --------- | ------------------- | -------------------------------- |
  | String    | getHostName()       | 클라이언트 IP 리턴               |
  | int       | getPort()           | 클라이언트 포트 번호 리턴        |
  | String    | toString()          | "IP:포트번호" 형태로 문자열 리턴 |

  더 이상 클라이언트 연결 수락이 필요 없으면 ServerSocket의 close() 메소드를 호출해서 포트를 언바인딩시켜야 한다. 그래야 다른 프로글매에서 해당 포트를 재사용할 수 있다.

  ```java
  serverSocket.close();
  ```

  

## UDP 네트워킹

